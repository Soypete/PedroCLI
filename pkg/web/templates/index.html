{{template "base" .}}

{{define "content"}}
<div class="max-w-6xl mx-auto">
    <!-- Tab Navigation -->
    <div class="mb-6">
        <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
            <button onclick="switchTab('coding')" id="tab-coding"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Coding Tools
            </button>
            <button onclick="switchTab('podcast')" id="tab-podcast"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Podcast Tools
            </button>
            <button onclick="switchTab('blog')" id="tab-blog"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Blog Tools
            </button>
        </div>
    </div>

    <!-- Coding Tools Section -->
    <div id="section-coding" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Coding Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Create and manage autonomous coding tasks</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1 order-1 lg:order-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 lg:sticky lg:top-4">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Job</h2>

                    <form id="create-job-form"
                          hx-post="/api/jobs"
                          hx-target="#job-list"
                          hx-swap="afterbegin"
                          class="space-y-4">

                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                            <select id="type" name="type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    onchange="updateFormFields(this.value)">
                                <option value="builder">Builder - Build new features</option>
                                <option value="debugger">Debugger - Fix issues</option>
                                <option value="reviewer">Reviewer - Review code</option>
                                <option value="triager">Triager - Diagnose issues</option>
                            </select>
                        </div>

                        <div id="description-field">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe what you want to build..."></textarea>
                        </div>

                        <div id="issue-field">
                            <label for="issue" class="block text-sm font-medium text-gray-700 mb-2">Issue # (optional)</label>
                            <input type="text" id="issue" name="issue"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="GH-123">
                        </div>

                        <div id="symptoms-field" class="hidden">
                            <label for="symptoms" class="block text-sm font-medium text-gray-700 mb-2">Symptoms</label>
                            <textarea id="symptoms" name="symptoms" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe the problem..."></textarea>
                        </div>

                        <div id="logs-field" class="hidden">
                            <label for="logs" class="block text-sm font-medium text-gray-700 mb-2">Logs (optional)</label>
                            <textarea id="logs" name="logs" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Paste error logs..."></textarea>
                        </div>

                        <div id="branch-field" class="hidden">
                            <label for="branch" class="block text-sm font-medium text-gray-700 mb-2">Branch</label>
                            <input type="text" id="branch" name="branch"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="feature/my-feature">
                        </div>

                        <!-- Research Links Section -->
                        <div class="border border-gray-200 rounded-md">
                            <button type="button" onclick="toggleResearchLinks('coding')"
                                    class="w-full px-4 py-2 text-left text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-t-md flex items-center justify-between">
                                <span>Research Links (optional)</span>
                                <svg id="coding-research-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="coding-research-panel" class="hidden p-4 space-y-3">
                                <p class="text-xs text-gray-500">Add URLs and notes as research context. The LLM can fetch and cite these.</p>

                                <div id="coding-research-links" class="space-y-2">
                                    <!-- Dynamic link rows added here -->
                                </div>

                                <button type="button" onclick="addResearchLink('coding')"
                                        class="text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Link
                                </button>

                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">General Notes</label>
                                    <textarea name="plain_notes" rows="2"
                                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="Additional context without URLs..."></textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Job
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2 order-2 lg:order-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Active Jobs</h2>
                    <button hx-get="/api/jobs" hx-target="#job-list" hx-swap="innerHTML"
                            class="text-sm text-blue-600 hover:text-blue-700 py-2 px-3">Refresh</button>
                </div>

                <div id="job-list" hx-get="/api/jobs" hx-trigger="load" hx-swap="innerHTML" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">Loading jobs...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Podcast Tools Section -->
    <div id="section-podcast" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Podcast Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Manage content for Domesticating AI podcast</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Job</h2>

                    <form id="podcast-job-form" class="space-y-4">
                        <div>
                            <label for="podcast-type" class="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                            <select id="podcast-type" name="type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="create_script">Create Script - Generate episode script</option>
                                <option value="create_outline">Create Outline - Generate episode outline</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="podcast-topic" class="block text-sm font-medium text-gray-700">Episode Topic</label>
                                <button type="button" onclick="startVoiceInput('podcast-topic')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="podcast-topic" name="topic" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="What is the episode about?"></textarea>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="podcast-notes" class="block text-sm font-medium text-gray-700">Notes (optional)</label>
                                <button type="button" onclick="startVoiceInput('podcast-notes')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="podcast-notes" name="notes" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Additional notes or context..."></textarea>
                        </div>

                        <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Job
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Active Jobs</h2>
                </div>
                <div id="podcast-job-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">No podcast jobs yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Tools Section -->
    <div id="section-blog" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Blog Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Dictate your thoughts - AI writes the post, suggests titles, tags, and social media content</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">New Post</h2>

                    <form id="blog-job-form" class="space-y-4">
                        <div>
                            <label for="blog-title" class="block text-sm font-medium text-gray-700 mb-2">Working Title (optional)</label>
                            <input type="text" id="blog-title" name="title"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="AI will suggest titles based on content...">
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="blog-content" class="block text-sm font-medium text-gray-700">Blog Prompt</label>
                                <button type="button" onclick="startVoiceInput('blog-content')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="blog-content" name="content" rows="8"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe your blog post... AI will research, outline, expand, and publish to Notion"></textarea>
                        </div>

                        <!-- Research Links Section -->
                        <div class="border border-gray-200 rounded-md">
                            <button type="button" onclick="toggleResearchLinks('blog')"
                                    class="w-full px-4 py-2 text-left text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-t-md flex items-center justify-between">
                                <span>Research Links (optional)</span>
                                <svg id="blog-research-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="blog-research-panel" class="hidden p-4 space-y-3">
                                <p class="text-xs text-gray-500">Add URLs as references. The LLM can fetch, summarize, and cite these in your post.</p>

                                <div id="blog-research-links" class="space-y-2">
                                    <!-- Dynamic link rows added here -->
                                </div>

                                <button type="button" onclick="addResearchLink('blog')"
                                        class="text-sm text-blue-600 hover:text-blue-700 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Link
                                </button>

                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">General Notes</label>
                                    <textarea id="blog-plain-notes" rows="2"
                                              class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="Additional context without URLs..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="publish-notion" name="publish" checked
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="publish-notion" class="ml-2 block text-sm text-gray-700">
                                    Publish to Notion
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="skip-ai" name="skip_ai"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="skip-ai" class="ml-2 block text-sm text-gray-700">
                                    Skip AI (post raw content directly)
                                </label>
                            </div>
                        </div>

                        <button type="submit" id="blog-submit-btn"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Post
                        </button>
                    </form>

                    <!-- AI Status Indicator -->
                    <div id="ai-status" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <div>
                                <p id="ai-status-text" class="text-sm font-medium text-blue-700">AI is writing...</p>
                                <p class="text-xs text-blue-600">This may take 30-60 seconds</p>
                            </div>
                        </div>
                    </div>

                    <p class="mt-4 text-xs text-gray-500 text-center">
                        AI will: expand dictation â†’ generate titles, tags & social posts â†’ publish to Notion
                    </p>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Recent Posts</h2>
                    <a href="https://www.notion.so/191a4c9f9845803bb008d16d6a025ba2" target="_blank"
                       class="text-sm text-blue-600 hover:text-blue-700 py-2 px-3">
                        View in Notion â†’
                    </a>
                </div>

                <div id="blog-post-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">Posts will appear here after creation</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'));

    // Deactivate all tabs
    document.querySelectorAll('.tab-button').forEach(el => {
        el.classList.remove('bg-blue-600', 'text-white');
        el.classList.add('text-gray-600', 'hover:bg-gray-100');
    });

    // Show selected section
    document.getElementById('section-' + tabName).classList.remove('hidden');

    // Activate selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
    activeTab.classList.add('bg-blue-600', 'text-white');

    // Save preference
    localStorage.setItem('pedrocli_active_tab', tabName);
}

// Update form fields based on job type (coding)
function updateFormFields(type) {
    document.getElementById('description-field').classList.add('hidden');
    document.getElementById('issue-field').classList.add('hidden');
    document.getElementById('symptoms-field').classList.add('hidden');
    document.getElementById('logs-field').classList.add('hidden');
    document.getElementById('branch-field').classList.add('hidden');

    switch(type) {
        case 'builder':
            document.getElementById('description-field').classList.remove('hidden');
            document.getElementById('issue-field').classList.remove('hidden');
            break;
        case 'debugger':
            document.getElementById('symptoms-field').classList.remove('hidden');
            document.getElementById('logs-field').classList.remove('hidden');
            break;
        case 'reviewer':
            document.getElementById('branch-field').classList.remove('hidden');
            break;
        case 'triager':
            document.getElementById('description-field').classList.remove('hidden');
            break;
    }
}

// Research Links Management
let researchLinkCounters = { coding: 0, blog: 0, podcast: 0 };

function toggleResearchLinks(formId) {
    const panel = document.getElementById(formId + '-research-panel');
    const arrow = document.getElementById(formId + '-research-arrow');

    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    } else {
        panel.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    }
}

function addResearchLink(formId) {
    const container = document.getElementById(formId + '-research-links');
    const index = researchLinkCounters[formId]++;

    const row = document.createElement('div');
    row.className = 'research-link-row p-3 bg-gray-50 rounded-md space-y-2';
    row.id = formId + '-link-' + index;

    row.innerHTML = `
        <div class="flex gap-2">
            <input type="url" name="link_url[]" placeholder="https://..."
                   class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <button type="button" onclick="removeResearchLink('${formId}', ${index})"
                    class="text-red-500 hover:text-red-700 px-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="flex gap-2">
            <input type="text" name="link_title[]" placeholder="Title (optional)"
                   class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <select name="link_category[]"
                    class="px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                <option value="">Category...</option>
                <option value="reference">Reference</option>
                <option value="citation">Citation</option>
                <option value="example">Example</option>
                <option value="research">Research</option>
                <option value="inspiration">Inspiration</option>
            </select>
        </div>
        <input type="text" name="link_notes[]" placeholder="Notes about this link..."
               class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        <input type="text" name="link_labels[]" placeholder="Labels (comma-separated)"
               class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    `;

    container.appendChild(row);
}

function removeResearchLink(formId, index) {
    const row = document.getElementById(formId + '-link-' + index);
    if (row) {
        row.remove();
    }
}

function collectResearchLinks(formId) {
    const container = document.getElementById(formId + '-research-links');
    const rows = container.querySelectorAll('.research-link-row');
    const links = [];

    rows.forEach(row => {
        const url = row.querySelector('input[name="link_url[]"]').value.trim();
        if (url) {
            const title = row.querySelector('input[name="link_title[]"]').value.trim();
            const category = row.querySelector('select[name="link_category[]"]').value;
            const notes = row.querySelector('input[name="link_notes[]"]').value.trim();
            const labelsStr = row.querySelector('input[name="link_labels[]"]').value.trim();
            const labels = labelsStr ? labelsStr.split(',').map(l => l.trim()).filter(l => l) : [];

            links.push({
                url: url,
                title: title || undefined,
                category: category || undefined,
                notes: notes || undefined,
                labels: labels.length > 0 ? labels : undefined
            });
        }
    });

    return links;
}

// Voice input using local Whisper server
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

function startVoiceInput(targetId) {
    const btn = event.target.closest('button');

    if (isRecording) {
        // Stop recording
        stopRecording(targetId, btn);
    } else {
        // Start recording
        startRecording(targetId, btn);
    }
}

async function startRecording(targetId, btn) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());

            // Create audio blob
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Send to Whisper server
            await transcribeAudio(audioBlob, targetId, btn);
        };

        mediaRecorder.start();
        isRecording = true;
        btn.innerHTML = 'â¹ï¸ Stop';
        btn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
        btn.classList.add('bg-red-600', 'hover:bg-red-700');

    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Could not access microphone: ' + error.message);
    }
}

function stopRecording(targetId, btn) {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        isRecording = false;
        btn.innerHTML = 'â³ Transcribing...';
        btn.disabled = true;
    }
}

async function transcribeAudio(audioBlob, targetId, btn) {
    try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm');
        formData.append('response_format', 'json');
        formData.append('temperature', '0.0');

        const response = await fetch('http://localhost:8081/inference', {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`Whisper server error: ${response.status}`);
        }

        const result = await response.json();
        const transcript = result.text || '';

        // Append to textarea
        const target = document.getElementById(targetId);
        if (target.value) {
            target.value += ' ' + transcript.trim();
        } else {
            target.value = transcript.trim();
        }

    } catch (error) {
        console.error('Transcription error:', error);
        alert('Transcription failed: ' + error.message + '\n\nMake sure Whisper server is running on port 8081');
    } finally {
        // Reset button
        btn.innerHTML = 'ðŸŽ¤ Voice';
        btn.disabled = false;
        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
        btn.classList.add('bg-gray-800', 'hover:bg-gray-700');
    }
}

// Blog form submission
async function submitBlogPost(event) {
    event.preventDefault();

    const title = document.getElementById('blog-title').value.trim();
    const dictation = document.getElementById('blog-content').value.trim();
    const skipAI = document.getElementById('skip-ai').checked;
    const publish = document.getElementById('publish-notion').checked;
    const submitBtn = document.getElementById('blog-submit-btn');
    const aiStatus = document.getElementById('ai-status');
    const aiStatusText = document.getElementById('ai-status-text');

    if (!dictation) {
        alert('Please provide some content to work with');
        return;
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = skipAI ? 'Posting...' : 'Starting AI...';

    // Show AI status if not skipping
    if (!skipAI) {
        aiStatus.classList.remove('hidden');
        aiStatusText.textContent = 'AI is researching and writing your blog post...';
    }

    // Collect research links
    const researchLinks = collectResearchLinks('blog');
    const plainNotes = document.getElementById('blog-plain-notes')?.value.trim() || '';

    try {
        const requestBody = {
            title: title,
            dictation: dictation,
            skip_ai: skipAI,
            publish: publish
        };

        // Only include research links if there are any
        if (researchLinks.length > 0) {
            requestBody.research_links = researchLinks;
        }
        if (plainNotes) {
            requestBody.plain_notes = plainNotes;
        }

        const response = await fetch('/api/blog', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
        });

        const data = await response.json();

        if (data.success) {
            // Clear form
            document.getElementById('blog-title').value = '';
            document.getElementById('blog-content').value = '';
            document.getElementById('skip-ai').checked = false;
            // Clear research links
            document.getElementById('blog-research-links').innerHTML = '';
            document.getElementById('blog-plain-notes').value = '';
            researchLinkCounters.blog = 0;

            // Add to recent posts list
            const postList = document.getElementById('blog-post-list');

            // Remove "no posts" placeholder if present
            const placeholder = postList.querySelector('.text-center.py-12');
            if (placeholder) {
                placeholder.remove();
            }

            // Build display title (use first suggested title or original)
            let displayTitle = title || 'Untitled';
            if (data.suggested_titles && data.suggested_titles.length > 0) {
                displayTitle = data.suggested_titles[0];
            }

            // Build tags display
            let tagsHtml = '';
            if (data.tags && data.tags.length > 0) {
                tagsHtml = `<div class="flex flex-wrap gap-1 mt-2">
                    ${data.tags.map(tag => `<span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">${tag}</span>`).join('')}
                </div>`;
            }

            // Build alternate titles display
            let altTitlesHtml = '';
            if (data.suggested_titles && data.suggested_titles.length > 1) {
                altTitlesHtml = `<div class="mt-2 text-xs text-gray-500">
                    <span class="font-medium">Other titles:</span>
                    ${data.suggested_titles.slice(1).join(' â€¢ ')}
                </div>`;
            }

            const newPost = document.createElement('div');
            newPost.className = 'bg-green-50 rounded-lg shadow-sm border border-green-200 p-4 transition-colors duration-1000';
            newPost.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">${displayTitle}</h3>
                        <p class="text-sm text-gray-500 mt-1">Just now â€¢ Not Started</p>
                        ${tagsHtml}
                        ${altTitlesHtml}
                    </div>
                    <span class="text-green-600 text-sm whitespace-nowrap ml-2">âœ“ Created</span>
                </div>
            `;
            postList.insertBefore(newPost, postList.firstChild);

            // Fade the green highlight after 3 seconds
            setTimeout(() => {
                newPost.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-4 transition-colors duration-1000';
            }, 3000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating blog post:', error);
        alert('Failed to create blog post: ' + error.message);
    } finally {
        // Re-enable button and hide status
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Post';
        aiStatus.classList.add('hidden');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Restore saved tab preference
    const savedTab = localStorage.getItem('pedrocli_active_tab') || 'coding';
    switchTab(savedTab);

    // Attach blog form handler
    const blogForm = document.getElementById('blog-job-form');
    if (blogForm) {
        blogForm.addEventListener('submit', submitBlogPost);
    }
});
</script>
{{end}}
