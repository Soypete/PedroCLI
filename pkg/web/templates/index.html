{{template "base" .}}

{{define "content"}}
<div class="max-w-6xl mx-auto">
    <!-- Tab Navigation -->
    <div class="mb-6">
        <div class="inline-flex rounded-lg border border-gray-200 bg-white p-1">
            <button onclick="switchTab('coding')" id="tab-coding"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Coding Tools
            </button>
            <button onclick="switchTab('podcast')" id="tab-podcast"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Podcast Tools
            </button>
            <button onclick="switchTab('blog')" id="tab-blog"
                    class="tab-button px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Blog Tools
            </button>
        </div>
    </div>

    <!-- Coding Tools Section -->
    <div id="section-coding" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Coding Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Create and manage autonomous coding tasks</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1 order-1 lg:order-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 lg:sticky lg:top-4">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Job</h2>

                    <form id="create-job-form"
                          hx-post="/api/jobs"
                          hx-target="#job-list"
                          hx-swap="afterbegin"
                          class="space-y-4">

                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                            <select id="type" name="type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    onchange="updateFormFields(this.value)">
                                <option value="builder">Builder - Build new features</option>
                                <option value="debugger">Debugger - Fix issues</option>
                                <option value="reviewer">Reviewer - Review code</option>
                                <option value="triager">Triager - Diagnose issues</option>
                            </select>
                        </div>

                        <div id="description-field">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="description" name="description" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe what you want to build..."></textarea>
                        </div>

                        <div id="issue-field">
                            <label for="issue" class="block text-sm font-medium text-gray-700 mb-2">Issue # (optional)</label>
                            <input type="text" id="issue" name="issue"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="GH-123">
                        </div>

                        <div id="symptoms-field" class="hidden">
                            <label for="symptoms" class="block text-sm font-medium text-gray-700 mb-2">Symptoms</label>
                            <textarea id="symptoms" name="symptoms" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Describe the problem..."></textarea>
                        </div>

                        <div id="logs-field" class="hidden">
                            <label for="logs" class="block text-sm font-medium text-gray-700 mb-2">Logs (optional)</label>
                            <textarea id="logs" name="logs" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Paste error logs..."></textarea>
                        </div>

                        <div id="branch-field" class="hidden">
                            <label for="branch" class="block text-sm font-medium text-gray-700 mb-2">Branch</label>
                            <input type="text" id="branch" name="branch"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="feature/my-feature">
                        </div>

                        <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Job
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2 order-2 lg:order-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Active Jobs</h2>
                    <button hx-get="/api/jobs" hx-target="#job-list" hx-swap="innerHTML"
                            class="text-sm text-blue-600 hover:text-blue-700 py-2 px-3">Refresh</button>
                </div>

                <div id="job-list" hx-get="/api/jobs" hx-trigger="load" hx-swap="innerHTML" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">Loading jobs...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Podcast Tools Section -->
    <div id="section-podcast" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Podcast Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Manage content for Domesticating AI podcast</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Create New Job</h2>

                    <form id="podcast-job-form" class="space-y-4">
                        <div>
                            <label for="podcast-type" class="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                            <select id="podcast-type" name="type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="create_script">Create Script - Generate episode script</option>
                                <option value="create_outline">Create Outline - Generate episode outline</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="podcast-topic" class="block text-sm font-medium text-gray-700">Episode Topic</label>
                                <button type="button" onclick="startVoiceInput('podcast-topic')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="podcast-topic" name="topic" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="What is the episode about?"></textarea>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="podcast-notes" class="block text-sm font-medium text-gray-700">Notes (optional)</label>
                                <button type="button" onclick="startVoiceInput('podcast-notes')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="podcast-notes" name="notes" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Additional notes or context..."></textarea>
                        </div>

                        <button type="submit"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Job
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Active Jobs</h2>
                </div>
                <div id="podcast-job-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">No podcast jobs yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Tools Section -->
    <div id="section-blog" class="tab-section hidden">
        <div class="mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Blog Tools</h1>
            <p class="mt-1 sm:mt-2 text-sm sm:text-base text-gray-600">Dictate your thoughts - AI writes the post, suggests titles, tags, and social media content</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">New Post</h2>

                    <form id="blog-job-form" class="space-y-4">
                        <div>
                            <label for="blog-title" class="block text-sm font-medium text-gray-700 mb-2">Working Title (optional)</label>
                            <input type="text" id="blog-title" name="title"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="AI will suggest titles based on content...">
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="blog-content" class="block text-sm font-medium text-gray-700">Dictation</label>
                                <button type="button" onclick="startVoiceInput('blog-content')"
                                        class="inline-flex items-center px-3 py-1 bg-gray-800 text-white text-sm rounded-md hover:bg-gray-700">
                                    ðŸŽ¤ Voice
                                </button>
                            </div>
                            <textarea id="blog-content" name="content" rows="8"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Dictate or type your thoughts... AI will expand this into a full blog post"></textarea>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="skip-ai" name="skip_ai"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="skip-ai" class="ml-2 block text-sm text-gray-700">
                                Skip AI (post raw dictation directly)
                            </label>
                        </div>

                        <button type="submit" id="blog-submit-btn"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Create Post
                        </button>
                    </form>

                    <!-- AI Status Indicator -->
                    <div id="ai-status" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <svg class="animate-spin h-5 w-5 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <div>
                                <p id="ai-status-text" class="text-sm font-medium text-blue-700">AI is writing...</p>
                                <p class="text-xs text-blue-600">This may take 30-60 seconds</p>
                            </div>
                        </div>
                    </div>

                    <p class="mt-4 text-xs text-gray-500 text-center">
                        AI will: expand dictation â†’ generate titles, tags & social posts â†’ publish to Notion
                    </p>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Recent Posts</h2>
                    <a href="https://www.notion.so/191a4c9f9845803bb008d16d6a025ba2" target="_blank"
                       class="text-sm text-blue-600 hover:text-blue-700 py-2 px-3">
                        View in Notion â†’
                    </a>
                </div>

                <div id="blog-post-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">Posts will appear here after creation</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching
function switchTab(tabName) {
    // Hide all sections
    document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'));

    // Deactivate all tabs
    document.querySelectorAll('.tab-button').forEach(el => {
        el.classList.remove('bg-blue-600', 'text-white');
        el.classList.add('text-gray-600', 'hover:bg-gray-100');
    });

    // Show selected section
    document.getElementById('section-' + tabName).classList.remove('hidden');

    // Activate selected tab
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
    activeTab.classList.add('bg-blue-600', 'text-white');

    // Save preference
    localStorage.setItem('pedrocli_active_tab', tabName);
}

// Update form fields based on job type (coding)
function updateFormFields(type) {
    document.getElementById('description-field').classList.add('hidden');
    document.getElementById('issue-field').classList.add('hidden');
    document.getElementById('symptoms-field').classList.add('hidden');
    document.getElementById('logs-field').classList.add('hidden');
    document.getElementById('branch-field').classList.add('hidden');

    switch(type) {
        case 'builder':
            document.getElementById('description-field').classList.remove('hidden');
            document.getElementById('issue-field').classList.remove('hidden');
            break;
        case 'debugger':
            document.getElementById('symptoms-field').classList.remove('hidden');
            document.getElementById('logs-field').classList.remove('hidden');
            break;
        case 'reviewer':
            document.getElementById('branch-field').classList.remove('hidden');
            break;
        case 'triager':
            document.getElementById('description-field').classList.remove('hidden');
            break;
    }
}


// Voice input using local Whisper server
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

function startVoiceInput(targetId) {
    const btn = event.target.closest('button');

    if (isRecording) {
        // Stop recording
        stopRecording(targetId, btn);
    } else {
        // Start recording
        startRecording(targetId, btn);
    }
}

async function startRecording(targetId, btn) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());

            // Create audio blob
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

            // Send to Whisper server
            await transcribeAudio(audioBlob, targetId, btn);
        };

        mediaRecorder.start();
        isRecording = true;
        btn.innerHTML = 'â¹ï¸ Stop';
        btn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
        btn.classList.add('bg-red-600', 'hover:bg-red-700');

    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Could not access microphone: ' + error.message);
    }
}

function stopRecording(targetId, btn) {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        isRecording = false;
        btn.innerHTML = 'â³ Transcribing...';
        btn.disabled = true;
    }
}

async function transcribeAudio(audioBlob, targetId, btn) {
    try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm');
        formData.append('response_format', 'json');
        formData.append('temperature', '0.0');

        const response = await fetch('http://localhost:8081/inference', {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`Whisper server error: ${response.status}`);
        }

        const result = await response.json();
        const transcript = result.text || '';

        // Append to textarea
        const target = document.getElementById(targetId);
        if (target.value) {
            target.value += ' ' + transcript.trim();
        } else {
            target.value = transcript.trim();
        }

    } catch (error) {
        console.error('Transcription error:', error);
        alert('Transcription failed: ' + error.message + '\n\nMake sure Whisper server is running on port 8081');
    } finally {
        // Reset button
        btn.innerHTML = 'ðŸŽ¤ Voice';
        btn.disabled = false;
        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
        btn.classList.add('bg-gray-800', 'hover:bg-gray-700');
    }
}

// Blog form submission
async function submitBlogPost(event) {
    event.preventDefault();

    const title = document.getElementById('blog-title').value.trim();
    const dictation = document.getElementById('blog-content').value.trim();
    const skipAI = document.getElementById('skip-ai').checked;
    const submitBtn = document.getElementById('blog-submit-btn');
    const aiStatus = document.getElementById('ai-status');
    const aiStatusText = document.getElementById('ai-status-text');

    if (!dictation) {
        alert('Please provide some content to work with');
        return;
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = skipAI ? 'Posting...' : 'Starting AI...';

    // Show AI status if not skipping
    if (!skipAI) {
        aiStatus.classList.remove('hidden');
        aiStatusText.textContent = 'AI is expanding your dictation...';
    }

    try {
        const response = await fetch('/api/blog', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                dictation: dictation,
                skip_ai: skipAI
            }),
        });

        const data = await response.json();

        if (data.success) {
            // Clear form
            document.getElementById('blog-title').value = '';
            document.getElementById('blog-content').value = '';
            document.getElementById('skip-ai').checked = false;

            // Add to recent posts list
            const postList = document.getElementById('blog-post-list');

            // Remove "no posts" placeholder if present
            const placeholder = postList.querySelector('.text-center.py-12');
            if (placeholder) {
                placeholder.remove();
            }

            // Build display title (use first suggested title or original)
            let displayTitle = title || 'Untitled';
            if (data.suggested_titles && data.suggested_titles.length > 0) {
                displayTitle = data.suggested_titles[0];
            }

            // Build tags display
            let tagsHtml = '';
            if (data.tags && data.tags.length > 0) {
                tagsHtml = `<div class="flex flex-wrap gap-1 mt-2">
                    ${data.tags.map(tag => `<span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">${tag}</span>`).join('')}
                </div>`;
            }

            // Build alternate titles display
            let altTitlesHtml = '';
            if (data.suggested_titles && data.suggested_titles.length > 1) {
                altTitlesHtml = `<div class="mt-2 text-xs text-gray-500">
                    <span class="font-medium">Other titles:</span>
                    ${data.suggested_titles.slice(1).join(' â€¢ ')}
                </div>`;
            }

            const newPost = document.createElement('div');
            newPost.className = 'bg-green-50 rounded-lg shadow-sm border border-green-200 p-4 transition-colors duration-1000';
            newPost.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">${displayTitle}</h3>
                        <p class="text-sm text-gray-500 mt-1">Just now â€¢ Not Started</p>
                        ${tagsHtml}
                        ${altTitlesHtml}
                    </div>
                    <span class="text-green-600 text-sm whitespace-nowrap ml-2">âœ“ Created</span>
                </div>
            `;
            postList.insertBefore(newPost, postList.firstChild);

            // Fade the green highlight after 3 seconds
            setTimeout(() => {
                newPost.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-4 transition-colors duration-1000';
            }, 3000);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating blog post:', error);
        alert('Failed to create blog post: ' + error.message);
    } finally {
        // Re-enable button and hide status
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Post';
        aiStatus.classList.add('hidden');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Restore saved tab preference
    const savedTab = localStorage.getItem('pedrocli_active_tab') || 'coding';
    switchTab(savedTab);

    // Attach blog form handler
    const blogForm = document.getElementById('blog-job-form');
    if (blogForm) {
        blogForm.addEventListener('submit', submitBlogPost);
    }
});
</script>
{{end}}
